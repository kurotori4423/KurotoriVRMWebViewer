# 開発・リファクタリング・ルール

## Git運用ルール

### 1. **リファクタリング前の必須コミット**
- **ルール**: 大きな変更・リファクタリングを開始する前に、必ず現在の動作状態をコミットする
- **理由**: Gitをバックアップとして活用し、複数のファイルバージョンによる混乱を防ぐ
- **適用タイミング**:
  - クラス構造の大幅な変更
  - ファイル分割・統合
  - アーキテクチャの変更
  - 大きな機能追加

### 2. **バックアップファイル作成禁止**
- **禁止**: `.backup`, `_old`, `_temp` 等の拡張子によるバックアップファイル作成
- **代替手段**: Gitコミット履歴を活用
- **緊急時の例外**: 最大1時間以内の一時バックアップのみ許可、作業完了後即削除

### 3. **テスト用ファイルの命名規則**
- **実験用ファイル**: `test-*`, `experiment-*`, `poc-*` で始める
- **保存期間**: 実験完了後24時間以内に削除またはコミット
- **ドキュメント**: 実験ファイルの目的をコミットメッセージに記載

## ファイル管理ルール

### 4. **エントリーポイントファイルの管理**
- **原則**: プロジェクトのエントリーポイントは `main.ts` に統一
- **禁止**: `main-full.ts`, `main-v2.ts` など複数のメインファイル併存
- **リファクタリング時**: 新実装は別ブランチで行い、完成後にmainブランチにマージ

### 5. **定期的なファイルクリーンアップ**
- **頻度**: 機能実装完了時、プルリクエスト前
- **対象**: 
  - 未使用のインポート文
  - 未参照のファイル
  - 一時的なテストファイル
  - コメントアウトされた大量のコード

## リファクタリングワークフロー

### 6. **段階的リファクタリング原則**
1. **現状コミット**: 動作する状態で必ずコミット
2. **ブランチ作成**: `refactor/feature-name` でブランチ作成
3. **小さな単位**: 一度に変更する責任範囲を限定
4. **継続的テスト**: 各段階で動作確認
5. **マージ**: 完全に動作することを確認してからマージ

### 7. **アーキテクチャ変更時の文書化**
- **必須**: 変更理由、移行手順、影響範囲をMemory Bankに記録
- **更新対象**: 
  - `refactoring-log.md`: 具体的な変更内容
  - `technical-architecture.md`: アーキテクチャの更新
  - `development-progress.md`: 進捗状況の更新

## コード品質ルール

### 8. **型安全性の確保**
- **TypeScriptエラー**: リファクタリング完了時にゼロエラーを必須
- **any型禁止**: 明確な型定義を義務付け
- **インターフェース活用**: 共通的な型は types/ フォルダで管理

### 9. **イベント駆動設計の維持**
- **EventBus活用**: コンポーネント間通信はEventBusを優先
- **疎結合**: 直接参照よりもイベント経由の通信を推奨
- **型安全**: イベント型定義を `types/events.ts` で厳密管理

## エラー防止策

### 10. **ファイル編集前の確認チェックリスト**
- [ ] 編集対象ファイルが実際に使用されていることを確認
- [ ] エントリーポイント（index.html）の参照先を確認
- [ ] 関連するimport文の整合性を確認
- [ ] 編集後にビルドエラーが発生しないことを確認

### 11. **混乱防止のための命名規則**
- **一時ファイル**: 必ず接頭辞付き（`temp-`, `test-`, `backup-`）
- **実装中ファイル**: 明確に識別できる名前（`feature-name-wip`）
- **完成ファイル**: 本来の名前に戻す

## 今回の教訓

### 12. **2025-06-27の問題と対策**
**問題**: 
- `index.html` が `main-full.ts` を参照していたため、編集していた `main.ts` が未使用だった
- バックアップファイル（`main.ts.backup`）や実験ファイル（`main-simple.ts`）が混在
- ファイル編集対象の誤認により、無駄な作業が発生

**対策**: 
- リファクタリング開始前のファイル構成確認を義務化
- バックアップファイル作成の禁止（Git活用）
- エントリーポイント参照の定期確認

**適用した解決策**:
- 未使用ファイルの削除（`main.ts`, `main.ts.backup`, `main-simple.ts`）
- `main-full.ts` → `main.ts` のリネーム
- `index.html` の参照更新

これらのルールにより、今後同様の混乱を防止し、効率的な開発・リファクタリングを実現する。

### 実装アプローチ
- **Info.mdの確認**: まず技術仕様を確認し、必要なTodoをDocs/Todo.mdに追加
- **段階的実装**: 機能を一つずつ実装し、その都度実装が正しいかどうか確認
- **シンプル重視**: シンプルな機能から実装を始め、徐々に機能を追加
- **モジュール分割**: 機能ごとにファイルを分けてコード管理を効率化
- **機能制限**: 実装時に必要以上の機能を追加せず、必要に応じて拡張

### コーディング品質基準
- **可読性重視**: 適切な変数名・関数名を使用し、理解しやすいコードを作成
- **意図説明**: コードの意図や動作をコメントで説明
- **複雑ロジック**: 特に複雑なロジックやアルゴリズムは詳細なコメントを追加

## メモリバンク・会話履歴管理

### 会話履歴圧縮時の記憶保持対策
- **定期的な進捗記録**: 開発中の現在の作業状況をdevelopment-progress.mdに随時更新
- **実行状況記録**: 現在実行中の機能実装、テスト結果、次のステップを明記
- **完了項目記録**: 完了した機能と残りのタスクを明確に分離
- **問題・課題記録**: 現在発生している問題や技術的課題をtrubleshooting.mdに記録
- **次回再開用情報**: 会話が再開された時にすぐに状況を把握できる情報を準備

### 記録すべき項目
1. **現在の実装対象**: どの機能を実装中か
2. **実装の進捗状況**: どこまで完了し、何が残っているか
3. **発生した問題**: エラーや技術的課題
4. **解決済み事項**: 解決した問題と解決方法
5. **次のアクション**: 次に取り組むべき具体的なタスク
6. **テスト状況**: どのテストを実行し、結果はどうだったか

### 記録タイミング
- 機能実装開始時
- 重要な実装完了時
- エラーや問題発生時
- テスト実行後
- ユーザーからの新しい要求があった時
- 長い会話が続いている時（20-30回のやり取りごと）

## テスト・品質管理

### Playwright MCP活用
- **デバッグ重視**: ブラウザでのデバッグが容易な実装を心がける
- **必須テスト**: 一つの機能実装完了後は必ずPlaywrightテストを実行
- **自動化推奨**: テストの自動化でより効果的な品質管理
- **動作確認**: 実装完了時の動作確認を徹底

### コードレビュー
- **フィードバック必須**: 実装完了後は必ずコードレビューを実施
- **継続改善**: レビュー結果を次の実装に反映

## Windows開発環境特有のルール

### ターミナルコマンド制約
- **PowerShell対応**: WindowsのコマンドプロンプトやPowerShell対応コマンドを使用
- **&&演算子禁止**: `&&`の代わりに`;`を使用してコマンド連結
  - ❌ 悪い例: `npm install && npm run build`
  - ✅ 良い例: `npm install; npm run build`
- **個別実行**: 複数コマンドの同時実行は避け、一つずつ実行
- **実行環境**: Visual Studio Code統合ターミナルでの実行

### 修正・改善プロセス
- **Todo追加**: 修正依頼時はTodo.mdに修正内容を追加
- **次回反映**: 修正内容を次の実装に必ず反映
- **メモ記録**: 重要な知見や個人メモは`.github/instructions/memo.instructions.md`に追記

## プロジェクト管理ルール

### ドキュメント管理
- **技術仕様**: `Docs/Info.md` - 技術選定と実装方針
- **タスク管理**: `Docs/Todo.md` - 実装タスクと進捗管理
- **開発ガイド**: `.github/instructions/general.instructions.md` - 基本ルール
- **技術メモ**: `.github/instructions/memo.instructions.md` - 実装知見と重要メモ

### 情報共有・記録
- **知見蓄積**: 開発で得た重要な知見は必ずmemo.instructions.mdに記録
- **問題解決**: トラブルシューティング情報の蓄積
- **ベストプラクティス**: 成功パターンと失敗パターンの記録

## 品質保証原則

### 実装品質
1. **機能完成**: 一つの機能を完全に実装してから次へ進む
2. **動作確認**: 各フェーズ完了時にPlaywrightテストで動作確認
3. **フィードバック**: 実装完了時の必須コードレビュー
4. **継続改善**: レビュー結果と修正内容の次回実装への反映

### コード品質
1. **命名規則**: 意味のある変数名・関数名の使用
2. **コメント**: 複雑なロジックには詳細な説明コメント
3. **モジュール性**: 機能ごとのファイル分割
4. **可読性**: 他の開発者が理解しやすいコード構造

この開発ルールに従うことで、高品質で保守しやすいVRMビューワーの開発を実現します。