# 開発・リファクタリング・ルール

## Git運用ルール

### 1. **リファクタリング前の必須コミット**
- **ルール**: 大きな変更・リファクタリングを開始する前に、必ず現在の動作状態をコミットする
- **理由**: Gitをバックアップとして活用し、複数のファイルバージョンによる混乱を防ぐ
- **適用タイミング**:
  - クラス構造の大幅な変更
  - ファイル分割・統合
  - アーキテクチャの変更
  - 大きな機能追加

### 2. **バックアップファイル作成禁止**
- **禁止**: `.backup`, `_old`, `_temp` 等の拡張子によるバックアップファイル作成
- **代替手段**: Gitコミット履歴を活用
- **緊急時の例外**: 最大1時間以内の一時バックアップのみ許可、作業完了後即削除

### 3. **テスト用ファイルの命名規則**
- **実験用ファイル**: `test-*`, `experiment-*`, `poc-*` で始める
- **保存期間**: 実験完了後24時間以内に削除またはコミット
- **ドキュメント**: 実験ファイルの目的をコミットメッセージに記載

## ファイル管理ルール

### 4. **エントリーポイントファイルの管理**
- **原則**: プロジェクトのエントリーポイントは `main.ts` に統一
- **禁止**: `main-full.ts`, `main-v2.ts` など複数のメインファイル併存
- **リファクタリング時**: 新実装は別ブランチで行い、完成後にmainブランチにマージ

### 5. **定期的なファイルクリーンアップ**
- **頻度**: 機能実装完了時、プルリクエスト前
- **対象**: 
  - 未使用のインポート文
  - 未参照のファイル
  - 一時的なテストファイル
  - コメントアウトされた大量のコード

## リファクタリングワークフロー

### 6. **段階的リファクタリング原則**
1. **現状コミット**: 動作する状態で必ずコミット
2. **ブランチ作成**: `refactor/feature-name` でブランチ作成
3. **小さな単位**: 一度に変更する責任範囲を限定
4. **継続的テスト**: 各段階で動作確認
5. **マージ**: 完全に動作することを確認してからマージ

### 7. **アーキテクチャ変更時の文書化**
- **必須**: 変更理由、移行手順、影響範囲をMemory Bankに記録
- **更新対象**: 
  - `refactoring-log.md`: 具体的な変更内容
  - `technical-architecture.md`: アーキテクチャの更新
  - `development-progress.md`: 進捗状況の更新

## コード品質ルール

### 8. **型安全性の確保**
- **TypeScriptエラー**: リファクタリング完了時にゼロエラーを必須
- **any型禁止**: 明確な型定義を義務付け
- **インターフェース活用**: 共通的な型は types/ フォルダで管理

### 9. **イベント駆動設計の維持**
- **EventBus活用**: コンポーネント間通信はEventBusを優先
- **疎結合**: 直接参照よりもイベント経由の通信を推奨
- **型安全**: イベント型定義を `types/events.ts` で厳密管理

## エラー防止策

### 10. **ファイル編集前の確認チェックリスト**
- [ ] 編集対象ファイルが実際に使用されていることを確認
- [ ] エントリーポイント（index.html）の参照先を確認
- [ ] 関連するimport文の整合性を確認
- [ ] 編集後にビルドエラーが発生しないことを確認

### 11. **混乱防止のための命名規則**
- **一時ファイル**: 必ず接頭辞付き（`temp-`, `test-`, `backup-`）
- **実装中ファイル**: 明確に識別できる名前（`feature-name-wip`）
- **完成ファイル**: 本来の名前に戻す

## 今回の教訓

### 12. **2025-06-27の問題と対策**
**問題**: 
- `index.html` が `main-full.ts` を参照していたため、編集していた `main.ts` が未使用だった
- バックアップファイル（`main.ts.backup`）や実験ファイル（`main-simple.ts`）が混在
- ファイル編集対象の誤認により、無駄な作業が発生

**対策**: 
- リファクタリング開始前のファイル構成確認を義務化
- バックアップファイル作成の禁止（Git活用）
- エントリーポイント参照の定期確認

**適用した解決策**:
- 未使用ファイルの削除（`main.ts`, `main.ts.backup`, `main-simple.ts`）
- `main-full.ts` → `main.ts` のリネーム
- `index.html` の参照更新

これらのルールにより、今後同様の混乱を防止し、効率的な開発・リファクタリングを実現する。