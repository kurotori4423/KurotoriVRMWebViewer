# 開発メモ・設計方針

## UI設計の方針

### フェーズ2.4: UI整理・改善の理由と方針

#### 背景
- フェーズ2の機能追加により、左サイドバーのUIが縦に長くなりすぎて画面に収まらない問題が発生
- ユーザビリティの向上のため、モーダルウィンドウやコンテキスト別ウィンドウの導入が必要

#### 新しいUI設計方針
1. **左サイドバー**: 常時表示される基本機能のみ
   - VRMファイル読み込みボタン（シンプル化）
   - 読み込み済モデル一覧
   - ライト設定
   - 背景設定

2. **中央モーダル**: VRMファイル読み込み関連機能
   - サンプル追加ボタン
   - ドラッグ&ドロップ領域
   - ×ボタンで閉じる機能
   - プリセットボタンは削除（シンプル化）

3. **右下ウィンドウ**: 選択モデルのコンテキスト操作
   - スケール設定
   - フォーカス・非表示・削除ボタン
   - 今後の拡張（ポージング、アニメーション等）に対応

#### 期待効果
- 画面の有効活用
- 機能別のコンテキスト分離
- 将来的な機能拡張への対応
- ユーザーの認知負荷軽減

## 技術的な実装方針

### モーダルウィンドウ
- CSS overlay/modalを使用
- ESCキーでの閉じる機能
- 背景クリックでの閉じる機能
- アニメーション付きの表示/非表示

### 選択モデル詳細ウィンドウ
- 右下固定位置
- モデル選択時の自動表示/非表示
- リサイズ可能な設計
- 今後の機能追加に対応した拡張性

### CSS設計
- モジュール化されたスタイル
- レスポンシブ対応
- ダークテーマ対応
- アクセシビリティ考慮

## フェーズ2.4実装完了報告

### 成果
✅ **UI整理・改善が完全に成功**

#### 実装された主要機能
1. **左サイドバーのシンプル化**
   - 縦スクロールの問題解決
   - 基本機能のみ常時表示
   - 画面の有効活用実現

2. **VRMファイル読み込みモーダル**
   - 中央モーダルウィンドウ実装
   - ×ボタン・ESCキーでの閉じる機能
   - アニメーション付き表示/非表示
   - 統合されたファイル選択・ドラッグ&ドロップ・サンプル機能

3. **選択モデル詳細ウィンドウ**
   - 画面右下固定位置
   - モデル選択時の自動表示
   - スケール・操作ボタンの統合
   - 今後の機能拡張に対応した設計

#### Playwrightテスト結果
- ✅ モーダルウィンドウの開閉
- ✅ VRM0サンプルの読み込み
- ✅ モデル選択とメタ情報表示（"ルーガン族 黒鳥用"）
- ✅ 詳細ウィンドウの表示・操作
- ✅ UI要素の正常動作

#### 技術的成果
- レスポンシブ対応
- ダークテーマ対応
- アクセシビリティ考慮
- モジュール化されたCSS設計

## 開発進捗メモ

### フェーズ2.4完了 (2024/12/28)

#### ✅ 完了した作業
- UI大幅リファクタリング完了
  - 左サイドバーのシンプル化（不要な要素削除）
  - VRMファイル読み込みモーダルの実装
  - 選択モデル詳細ウィンドウの実装（右下固定位置）
- 重要なバグ修正
  - `setSelectedModelScale` → `setModelScale` メソッド名修正
  - `centerSelectedModel` → `centerModel` メソッド名修正
  - `removeSelectedModel` → `deleteSelectedModel` メソッド名修正
  - HTMLに存在しない要素へのアクセスエラー修正（setupBackgroundHandlers）
- Playwright MCPを使用したブラウザテスト実施
  - スケール機能の動作確認（1.6 → 0.5への変更確認）
  - フォーカス機能の動作確認
  - 中央配置機能の動作確認
  - 全UI要素の正常動作確認

#### 🎯 確認できた動作
- VRMサンプル読み込み: ✅
- モデル選択: ✅  
- スケール調整: ✅ コンソールログでsetModelScale呼び出し確認済み
- フォーカス機能: ✅
- 中央配置機能: ✅
- モーダル開閉: ✅
- 詳細ウィンドウ開閉: ✅

#### 🚀 次のステップ
フェーズ3: VRMメタ情報表示の実装に移行
- メタ情報パネルの作成
- モデル名、作者、ライセンス情報の表示
- サムネイル画像の表示
- VRMバージョン情報の表示

フェーズ2.4は完全に完了。すべてのUI/UX改善とバグ修正が成功。

## バグ修正メモ

### フェーズ2.4後のバグ修正 (2024/12/28)

#### 🐛 修正したバグ
1. **モデル名表示の不一致**
   - 問題: 選択モデル操作ウィンドウで表示されるモデル名が、実際に選択したモデルの名前と異なっていた
   - 原因: `updateSelectedModelControls`関数と`updateModelList`関数でモデル名取得ロジックが異なっていた
   - 修正: 両関数で同じロジック`(selectedModel.meta as any).name`を使用するように統一

2. **非表示ボタンの動作不良**
   - 問題: 非表示ボタンが正常に動作していなかった
   - 原因: イベントハンドラーが重複して登録されており、古いロジックが残っていた
   - 修正: 重複したイベントハンドラーを削除し、`updateSelectedModelControls`呼び出しを追加

3. **削除確認ダイアログの重複**
   - 問題: モデル削除時に確認ダイアログが2回表示されていた
   - 原因: deleteSelectedBtnのイベントハンドラーが重複して登録されていた
   - 修正: 重複したイベントハンドラーを削除

#### ✅ 確認できた修正結果
- Model 1を選択 → 詳細ウィンドウに「Model 1」と正しく表示
- ルーガン族 黒鳥用を選択 → 詳細ウィンドウに「ルーガン族 黒鳥用」と正しく表示
- 非表示ボタン → 「非表示」↔「表示」の切り替えが正常動作
- 削除ボタン → 確認ダイアログが1回のみ表示、削除処理正常動作

#### 📁 修正ファイル
- `src/main.ts`: イベントハンドラーの重複削除、モデル名取得ロジック統一

すべてのユーザー報告バグが修正され、正常動作を確認。

### フェーズ3: VRMメタ情報表示 完了 (2024/12/28)

#### ✅ 実装した機能
1. **Infoボタンの追加**
   - 読み込み済モデルリストの各項目にInfoボタンを追加
   - ユーザー要求に従い、モデル名の右側に配置

2. **メタ情報モーダルウィンドウ**
   - 美しいデザインのモーダルウィンドウを実装
   - ×ボタン、ESCキー、背景クリックで閉じる機能
   - レスポンシブデザイン対応

3. **包括的なメタ情報表示**
   - **基本情報**: モデル名、作者、VRMバージョン（0.x / 1.0）
   - **ライセンス情報**: 商用利用許可、利用許可対象、ライセンス名、詳細URL
   - **連絡先・その他**: 連絡先情報、参照情報
   - VRM0とVRM1の両方のメタ情報形式に対応

4. **ライセンス情報の視覚化**
   - 商用利用: 許可/禁止のカラーバッジ表示
   - 利用許可: 作者のみ/ライセンス対象者のみ/全員のバッジ表示
   - VRMバージョンバッジ表示

#### 🎯 テスト結果
- ✅ VRM0サンプル: 作者「kurotori」、商用利用「禁止」、利用許可「作者のみ」を正確に表示
- ✅ VRM1サンプル: モデル名「ルーガン族 黒鳥用」、VRMバージョン「VRM 1.0」を正確に表示
- ✅ Infoボタンクリック → メタ情報モーダル表示
- ✅ ESCキーでモーダル閉じる
- ✅ ×ボタンでモーダル閉じる
- ✅ モデル選択機能との干渉なし

#### 📁 実装ファイル
- `src/main.ts`: Infoボタン、モーダル、メタ情報表示機能
- `src/style.css`: Infoボタン、メタ情報モーダルのスタイル

#### 🚀 次のステップ
サムネイル画像表示は将来のバージョンで対応予定（メタ情報にサムネイル表示用のプレースホルダーは実装済み）

フェーズ3.1: VRMメタ情報表示はほぼ完了。次はフェーズ3.2: lil-gui統合、またはフェーズ4: ポージング機能の開始を検討。

## フェーズ3実装完了（2025年6月27日）

### VRMメタ情報表示機能
- **Infoボタン**: 各モデルリストアイテムの右側に配置
- **メタ情報モーダル**: クリックで開く詳細情報ウィンドウ
- **表示内容**:
  - 基本情報: モデル名、作者、VRMバージョン（0.x/1.0対応）
  - ライセンス情報: 商用利用、利用許可、ライセンス詳細
  - 連絡先・その他情報: 必要に応じて表示
- **操作性**:
  - ×ボタン、ESCキー、背景クリック全てでモーダルを閉じる
  - Infoボタンクリック時にモデル選択を阻害しない設計

### Playwrightテスト結果
- ✅ VRM0/VRM1サンプルでの動作確認
- ✅ 複数モデル読み込み時の動作確認
- ✅ モーダル開閉機能の動作確認
- ✅ ESCキーでのモーダル閉じる機能
- ✅ 既存のモデル選択機能への影響なし

### 技術実装詳細
- **HTML**: `meta-info-modal`要素とその構造
- **CSS**: レスポンシブ対応、ダークモード対応、バッジスタイル
- **JavaScript**: 
  - `showMetaInfoModal()`: モーダル表示
  - `generateMetaInfoHTML()`: メタ情報HTML生成
  - `hideMetaInfoModal()`: モーダル非表示
  - イベントハンドラー: クリック、ESCキー、背景クリック

### 残りタスク
- [ ] サムネイル画像の表示実装（`meta.texture`からの画像表示）

### 次のフェーズ推奨
- フェーズ3.2: lil-gui統合 
- フェーズ4: ポージング機能の実装

## メタ情報取得方式の修正（2025年6月27日）

### 実施した修正
- **VRMローダー設定**: `needThumbnailImage = true` でサムネイル画像読み込みを有効化
- **メタ情報アクセス**: `vrm.meta` → `gltf.userData.vrmMeta` に修正
- **VRMインスタンスへの追加**: `(vrm as any).vrmMeta = vrmMeta` で後からアクセス可能にする
- **メタ情報表示ロジック**: VRM0.x/VRM1.0の違いに対応したHTML生成
- **サムネイル画像表示**: `vrmMeta.thumbnailImage.src` で実際の画像表示

### 確認結果
- ✅ VRM1.0: 基本情報（名前、作者、バージョン）+ ライセンスURL + サムネイル画像
- ✅ VRM0.x: 基本情報（名前、バージョン）+ 詳細ライセンス情報（商用利用、利用許可等）
- ✅ 両形式でサムネイル画像が正常に表示される
- ✅ モデル名表示も修正され、選択モデル詳細ウィンドウでも正しく表示

### 技術詳細
Three-VRMの正式なメタ情報取得方法に従い、`gltf.userData.vrmMeta`からの取得に統一。
VRM0.xとVRM1.0でメタ情報の構造が異なるため、条件分岐で適切に処理。

## 開発プロセスの改善（2025年6月27日）

### コミット戦略の確立
- **各フェーズ完了時**: 必ずコミットを実行
- **各機能実装完了時**: 動作確認後に即座にコミット
- **バグ修正完了時**: 修正とテスト完了後にコミット
- **リファクタリング完了時**: 動作確認後にコミット

### コミットメッセージ規約
- **feat**: 新機能追加
- **fix**: バグ修正
- **refactor**: リファクタリング
- **docs**: ドキュメント更新
- **test**: テスト追加・修正
- **style**: コードスタイル修正

### フェーズ3完了
- VRMメタ情報表示機能の完全実装
- Three-VRMの正式なメタ情報取得方式への対応
- サムネイル画像表示の実装完了
- VRM0.x/VRM1.0両形式への対応
- Playwright MCPによる動作確認完了

### 次のステップ
フェーズ3.2 (lil-gui統合) またはフェーズ4 (ポージング機能) の選択

## 開発環境の制約・注意点（2025年6月27日）

### PowerShell制約
- **&&演算子**: PowerShellでは `&&` 演算子が使用できない
  - ❌ `git add . && git commit -m "message"`
  - ✅ `git add .` → 改行 → `git commit -m "message"`
  - 複数のコマンドを連続実行する場合は個別に実行する必要がある
- **対策**: 複数のコマンドは `run_in_terminal` ツールで分割して実行

### Git操作のベストプラクティス
- 各ステップ完了時にコミットを実行する際は、コマンドを分割
- `git add .` → `git commit -m "..."`の順序で実行
- コミットメッセージは詳細かつ明確に記述

## フェーズ3: VRMメタ情報表示機能完了メモ (2024/12/28)

### ✅ VRM0/VRM1バージョン検知・メタ情報対応完了

#### 重要な実装成果
**VRM0系とVRM1系のメタ情報構造の違いに完全対応**

1. **VRMバージョン検知ロジック強化**
   - VRM0系の特徴的プロパティ（title, author, commercialUssageName, allowedUserName等）を優先的にチェック
   - VRM1系の特徴的プロパティ（metaVersion, authors, commercialUsage等）との明確な区別
   - VRM0系が誤ってVRM1として検知される問題を解決

2. **メタ情報正規化処理実装**
   - VRM0系: `title → name`, `author → authors配列`変換
   - VRM1系: 既存の`name`, `authors配列`をそのまま使用
   - 両形式を統一されたインターフェースで扱う正規化層追加

3. **UI表示分岐実装**
   - VRM0系: 詳細なライセンス情報（商用利用、利用許可、暴力・性的表現、ライセンス名等）
   - VRM1系: 新形式のライセンス情報（ライセンスURL、商用利用、改変許可等）
   - 両形式でサムネイル画像表示対応

#### 技術的詳細

**VRMバージョン検知アルゴリズム改善**:
```typescript
// VRM0.x系の特徴的プロパティを優先チェック
if (vrmMeta?.title !== undefined || 
    vrmMeta?.author !== undefined || 
    vrmMeta?.commercialUssageName !== undefined) {
  // VRM0として処理
}
// VRM1.x系のプロパティチェック
else if (vrmMeta?.metaVersion !== undefined ||
         vrmMeta?.authors || vrmMeta?.commercialUsage !== undefined) {
  // VRM1として処理
}
```

**メタ情報正規化処理**:
- VRM0: `{title, author, version, commercialUssageName, allowedUserName, violentUssageName, sexualUssageName, licenseName}`
- VRM1: `{name, authors[], metaVersion, commercialUsage, modification, licenseUrl}`
- 統一: `{name, authors[], detectedVersion, isVRM0, isVRM1, thumbnailImage, ...}`

#### Playwrightテスト結果
- ✅ VRM0サンプル: 正しく「VRM 0.0」として検知・表示
- ✅ VRM1サンプル: 正しく「VRM 1.1」として検知・表示
- ✅ VRM0系メタ情報: タイトル、作者、詳細ライセンス情報、バージョン情報表示
- ✅ VRM1系メタ情報: 名前、作者配列、ライセンスURL、商用利用・改変許可、サムネイル表示
- ✅ 両バージョン共存: 複数モデル読み込み時の個別バージョン判定

#### 重要な設計判断
1. **VRM0優先検知**: VRM0系プロパティを先にチェックし、VRM1との誤認識を防止
2. **正規化レイヤー**: 両形式を統一インターフェースで扱うことで、UI層での分岐を最小化
3. **デバッグログ強化**: バージョン検知プロセスの可視化でトラブルシューティングを支援

#### 今後の拡張対応
- 新しいVRMバージョンへの対応は`detectVRMVersion`と`normalizeVRMMetadata`の修正のみで可能
- UI表示は正規化されたメタ情報を使用するため、表示ロジックの変更は最小限

## フェーズ3.2の方針変更

### 変更内容（2025年6月27日）
- **旧フェーズ3.2**: lil-gui統合（カメラ・ライト・モデル表示設定パネル）
- **新フェーズ3.2**: ライト調整機能（色調整・方向性ライト操作）

### 変更理由
1. **GUI要素の充実**: フェーズ3.1完了時点で既に独自UIが十分実装されており、lil-guiの必要性が低下
2. **ユーザビリティ**: 統一されたUIデザインによる一貫性の維持
3. **機能拡張**: ライト操作により実用的な機能（方向性ライトのTransformControls操作等）に重点

### 新フェーズ3.2の実装方針
1. **ライト色調整**: AmbientLight・DirectionalLightの色をカラーピッカーで調整
2. **ライト操作**: DirectionalLightHelperの表示とTransformControlsによる回転操作
3. **視覚フィードバック**: ライト選択時のハイライト・リアルタイムプレビュー
4. **設定保存**: ライトプリセット・デフォルト復元機能

### 次のステップ
- フェーズ3.2: ライト調整機能の実装
- フェーズ4: ポージング機能の実装
