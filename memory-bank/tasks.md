# Level 2 Enhancement Task: アバター選択表示の三角錐マーカー方式実装

**タスクID**: FEAT-003  
**開始日時**: 2025年6月28日 13:38:24  
**タスク種別**: Level 2 (Simple Enhancement)  
**推定作業時間**: 1時間  

## タスク概要

VRMモデル選択時の表示方式を従来のバウンディングボックス（ワイヤーフレーム）方式から、アバターの頭上に下向きの三角錐マーカーが表示される方式に変更する。視覚的に邪魔にならず、選択状態が明確に分かる実装を目指す。

## 要求仕様

### 現在の問題
- バウンディングボックス表示が大きく、見た目が邪魔
- ワイヤーフレーム表示が視覚的にうるさい

### 新仕様
- **表示方式**: アバターの頭上に下向きの三角錐マーカー
- **位置**: VRMモデルの頭頂部から一定距離上方
- **形状**: 下向きの三角錐（コーン形状）
- **色**: 目立つ色（例：オレンジ、黄色など）
- **サイズ**: アバターサイズに対して適切な比率
- **動作**: VRMモデル選択時に表示、選択解除時に非表示

## 技術設計

### アーキテクチャ方針
- **位置**: `src/core/SelectionManager.ts`の既存選択ロジックを拡張
- **新規クラス**: `MarkerRenderer`クラスの作成を検討
- **Three.js要素**: `THREE.ConeGeometry` + `THREE.MeshBasicMaterial`を使用

### 実装ステップ
1. **Phase 1**: 三角錐マーカーの基本表示実装 ✅
2. **Phase 2**: VRMモデル頭頂部位置の自動検出 ✅
3. **Phase 3**: 既存選択システムとの統合 ✅

## 実装記録

### Phase 1: 基本表示実装（完了）
- **日時**: 2025年6月28日 13:40頃
- **内容**: `SelectionManager.ts`の修正完了
  - `outlineMesh`を`selectionMarker`に変更
  - `showOutline()`を`showSelectionMarker()`に変更
  - バウンディングボックスから三角錐（ConeGeometry）に変更
  - 色：オレンジ（#ff6600）、透明度：0.8、下向き設定

### Phase 2: 位置計算の実装（完了）
- **内容**: VRMサイズに基づく自動位置計算
  - マーカー高さ：VRM高さの15%
  - マーカー半径：高さの80%
  - 配置位置：VRM頭頂部から高さの60%上方

### Phase 3: 複数モデル対応の検証（完了）
- **検証日時**: 2025年6月28日 13:44:53
- **テスト内容**: 
  - サンプルVRM0とVRM1の同時読み込み
  - 自動配置機能の動作確認（1つ目：原点、2つ目：X軸+2.5）
  - 各モデルの三角錐マーカー位置計算結果：
    - VRM #0: マーカー位置(0.000, 2.248, -0.302)
    - VRM #1: マーカー位置(2.500, 2.248, -0.302)
- **結果**: 複数体読み込み・表示が正常動作、エラーなし

## 完了基準

- ✅ VRMモデル選択時に頭上に三角錐マーカーが表示される
- ✅ マーカーの位置がVRMモデルの移動に追従する
- ✅ 選択解除時にマーカーが適切に削除される
- ✅ 既存のボーン操作機能に影響しない
- ✅ 複数VRMモデル対応（同時選択時の適切な処理）

## 参考情報

**従来実装の場所**:
- `src/core/SelectionManager.ts`: `updateSelectionVisualization()`メソッド
- `src/core/VRMViewerRefactored.ts`: モデル選択・描画ループ

**Three.js参考API**:
- `THREE.ConeGeometry`: 三角錐形状作成
- `THREE.Object3D.getObjectByName()`: VRM頭部ボーン取得
- `THREE.Box3.getCenter()`: バウンディングボックス中心点取得

---

**🎯 Goal**: 視覚的に美しく、機能的に優れた選択表示システムの実現  
**📅 完了日時**: 2025年6月28日 13:44:53  
**✨ Status**: 全Phase完了、複数体読み込み対応済み 